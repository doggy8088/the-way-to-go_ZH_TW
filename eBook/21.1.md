# 21.1 Heroku：一個使用 Go 的高度可用一致資料儲存

http://www.heroku.com/（引用 39）

Heroku 是一家位於美國舊金山的矽谷公司，最近被 Salesforce.com 公司（它為 Ruby 和 Rails、Java、Clojure 和 node.js 應用程式提供強大的、可擴充套件的、特別是非常易於管理的雲主機）收購。Heroku 的兩位工程師，Keith Rarick 和 Blake Mizerany 設計了一個開源的 "分散式啟動系統"，名為 **Doozer**，用於管理跨叢集機器的程序，並從實例故障和網路故障中優雅地恢復分割槽。其中一個需求是，他們需要可靠地同步和在許多伺服器之間共享訊息。

系統中的每台伺服器都需要有很多關於系統整體的訊息（設定資料、鎖 (lock) 等），以便能夠進行協調，而且這些訊息需要保持一致，即使在資料儲存失敗時也可以使用。因此他們需要一個具有堅實一致性保證的資料儲存。為此，他們開發了 Doozer，一個用 Go 語言編寫的、新的、一致的、高度可用的資料儲存，並且仿照谷歌的（封閉原始碼）Chubby 程式來管理他們的後端基礎設施。

Doozer 以 Paxos 為基礎（Paxos 是一個由不可靠節點組成的的不可靠網路中解決共識問題的協定族），雖然 Paxos 對執行容錯系統至關重要，但它因難以實現而臭名昭著。即使是在網上可以找到的實例實現也很複雜，很難遵循，儘管已經為了教育目的而被簡化過。而現有的生產系統以更糟糕而聞名。

Doozer 是作為建立分散式系統的一個堅硬的基礎而被開發的。

- 一個高度可用的（在網路分割槽期間工作）。
- 一致性（沒有不一致的寫入）。
- 資料儲存（用於少量的資料）。

正如開發人員所說：

> "Doozer 是你放置家族珠寶的地方"。

它提供了一個單一的基本同步元素：比較-設定對 (compare-config)。

用例：
- 資料庫主選 (Databases master election)
- 命名服務
- 設定

<u>為什麼選擇 Go，Go 的特點如何使其成為一個成功的產品：</u>

Paxos 是以獨立的、併發的程序來定義的，這些程序透過傳遞訊息進行通訊。這正是 *Go 的併發原語*（goroutines 和 channel，見 [第 14 章](14.0.md)）所擅長的問題。在 Doozer 中，這些程序被實現為 *goroutines*，他們的通訊被實現為*通道操作*。就像 Go 的*垃圾收集器*將記憶體使用量降到最低一樣，Doozer 的開發者發現 goroutines 和通道改進了基於鎖的併發方法。這些工具讓他們避免了複雜的『記賬』 (bookkeeping) 方式，並將注意力集中在手頭的問題上。他們仍然驚訝於只用了幾行程式碼就實現了以困難著稱的東西。

Go 中的*標準套件*是對於 Doozer 的另一個大成功，其中最值得一提的是 `websocket` 套件。

下面是開發人員自己的一些使用後的感受：

> 『……例如，我們很快就發現 `websocket` 是一個有用的套件。一旦我們有了一個工作的資料儲存，我們就需要一個簡單的方法來反省 (introspect) 它並將活動視覺化。使用 `websocket` 套件，Keith 能夠在回家的火車上新增 web 瀏覽器，而且不需要外部依賴。這就是 Go 將系統和應用程式設計完美結合的一個真實證明。
>
> 『部署 Doozer 的過程簡單得令人滿意。Go 建立靜態連結的二進位檔案，這意味著 Doozer 沒有外部依賴；它是一個單一的檔案，可以複製到任何機器上，並立即啟動，加入執行中的 Doozer 叢集。
>
> 『最後，Go 對簡單性和正交性 (orthogonality) 的狂熱關注與我們對軟體工程的看法是一致的。和 Go 團隊一樣，我們對 Doozer 的屬性也是固執的 (pragmatic)。我們關注細節，更傾向於改變現有的功能而不是引入新的功能。在這個意義上，Go 是一個與 Doozer 的完美對應。我們已經有了關於 Go的未來專案。Doozer 只是一個更大的系統的開始。』

他們還喜歡自動格式化工具 *gofmt*，以實現一致的程式碼風格和佈局，從而避免了對這些話題的討論。

其他語言也提供了一些類似的併發機制——比如 Erlang 和 Scala，但 Go 的設計也是為了提供最大的效率和控制。在另一篇文章中（[引用 12]()）Keith Rarick 指出：

> 『Go 來自於 C 和 C++ 這樣的系統程式語言，所以它讓你有能力真正控制性能屬性。當需要測量事物並確保其執行速度的時候，你有足夠的靈活性來真正進入那裡並做你需要的事情。當你發現你的程式執行緩慢的原因時，你就可以真正控制你所需要的東西來解決它。Go 給了你一個獨特的組合：C 語言給了你控制權，但它並不適合於併發。它甚至沒有給你提供垃圾收集。Go 為你提供了併發性和垃圾收集，但它仍然讓你控制記憶體佈局和資源使用。』

在 Doozer 中，Go 主要作為一種系統程式語言使用。更多的技術描述可以在（[引用 38]()）找到；程式碼可在 https://github.com/ha/doozer 找到。

## 連結

- [目錄](directory.md)
- 上一節：[真實世界中 Go 的使用](21.0.md)
- 下一節：[MROffice：一個使用 Go 的呼叫中心網絡電話 (VOIP) 系統](21.2.md)